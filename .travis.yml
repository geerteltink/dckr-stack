language: bash
services: docker

env:
  - PACKAGE=php VERSION=7.4-cli
  - PACKAGE=php VERSION=7.4-fpm
  - PACKAGE=php VERSION=7.4-test
  - PACKAGE=mysql VERSION=latest
  - PACKAGE=nginx VERSION=latest

before_script:
  - env | sort
  - cd "$PACKAGE"

script:
  - |
    (
      set -Eeuo pipefail
      set -x
      docker build --pull --file "$VERSION.dockerfile" --tag "xtreamwayz/$PACKAGE:$VERSION" --cache-from "xtreamwayz/$PACKAGE:$VERSION" .
    )

after_script:
  - docker images

before_deploy:
  - echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin

deploy:
  - provider: script
    script: docker push "xtreamwayz/$PACKAGE:$VERSION"
    on:
      branch: master
